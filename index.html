<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Wanz WA Connect Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
<script src="wanzdev.js"></script>
<style>
  body {
    margin: 0;
    background: #010307;
    color: #c7fff1;
    font-family: 'Orbitron', monospace;
    overflow-x: hidden;
  }
  .wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    position: relative;
    text-align: center;
  }
  .lightning {
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at 30% 20%, rgba(0,255,156,0.15), transparent 20%),
                radial-gradient(circle at 70% 80%, rgba(0,167,255,0.15), transparent 20%);
    filter: blur(60px);
    animation: flicker 3s infinite;
  }
  @keyframes flicker { 0%,100%{opacity:.05;} 50%{opacity:.2;} }

  .card {
    width: 90%;
    max-width: 700px;
    background: rgba(5,15,15,0.9);
    border: 1px solid rgba(0,255,156,0.2);
    border-radius: 14px;
    padding: 24px;
    box-shadow: 0 0 50px rgba(0,255,156,0.2);
    z-index: 2;
  }

  h1 {
    color: #00ff9c;
    text-shadow: 0 0 10px rgba(0,255,156,0.5);
    margin: 0 0 8px;
  }

  .muted { color: #7fb0a6; font-size: 13px; }
  label { display: block; margin-top: 10px; font-size: 13px; color: #7fb0a6; text-align: left; }
  input, textarea {
    width: 100%;
    padding: 10px;
    margin-top: 4px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.1);
    background: transparent;
    color: #e6fff6;
    font-family: monospace;
  }
  textarea { min-height: 100px; resize: none; }

  .btn {
    display: inline-block;
    padding: 10px 16px;
    margin-top: 12px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    transition: transform 0.2s;
  }
  .btn-primary {
    background: linear-gradient(90deg,#00ff9c,#00a8ff);
    color: #021711;
    box-shadow: 0 0 20px rgba(0,255,156,0.3);
  }
  .btn-primary:hover { transform: scale(1.05); }
  .btn-ghost {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.2);
    color: #7fb0a6;
  }

  .pill {
    display: inline-block;
    margin-top: 12px;
    padding: 6px 14px;
    border-radius: 999px;
    background: rgba(0,255,156,0.08);
    font-weight: 700;
    color: #00ff9c;
  }

  .code {
    background: #001914;
    padding: 10px;
    border-radius: 8px;
    margin-top: 10px;
    font-size: 18px;
    letter-spacing: 3px;
    text-align: center;
    color: #00ff9c;
    border: 1px dashed #00ff9c;
  }

  .log {
    margin-top: 12px;
    background: rgba(255,255,255,0.05);
    padding: 10px;
    border-radius: 8px;
    font-size: 13px;
    min-height: 80px;
    overflow: auto;
    max-height: 200px;
    text-align: left;
  }

  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  .overlay.show { display: flex; }
  .modal {
    background: #041214;
    padding: 20px;
    border-radius: 12px;
    max-width: 420px;
    width: 90%;
    border: 1px solid rgba(0,255,156,0.3);
    box-shadow: 0 0 40px rgba(0,255,156,0.3);
  }
  .modal h3 { margin: 0; color: #00ff9c; }
</style>
</head>
<body>
<div class="wrap">
  <div class="lightning"></div>
  <div class="card">
    <h1>XCVI SIMILARITY</h1>
    <p class="muted">
      Domain & Port diset di <code>wanzdev.js</code><br>
      Domain: <b id="domainShow"></b> | Port: <b id="portShow"></b>
    </p>

    <div id="serverStatus" class="pill">Server: mengecek...</div>

    <label>Nama Session</label>
    <input id="nameInput" placeholder="contoh: wanz">

    <label>Nomor (format internasional tanpa +)</label>
    <input id="phoneInput" placeholder="628xxxxxx">

    <button class="btn btn-primary" id="btnConnect">Connect</button>
    <button class="btn btn-ghost" id="btnDisconnect" style="display:none">Disconnect</button>

    <div class="pill" id="statusPill">Status: idle</div>
    <div id="pairingCode" class="code">‚Äî</div>

    <hr style="margin:20px 0;border:none;border-top:1px solid rgba(255,255,255,0.1)">

    <label>Nomor Tujuan</label>
    <input id="sendTo" placeholder="628xxxxxx">
    <label>Pesan</label>
    <textarea id="sendText" placeholder="Halo dari panel..."></textarea>
    <button class="btn btn-primary" id="btnSend">Kirim Pesan</button>
    <button class="btn btn-ghost" id="btnSessions">Lihat Sessions</button>

    <div class="log" id="logBox">[Log siap...]</div>
  </div>
</div>

<!-- Modal -->
<div class="overlay" id="overlay">
  <div class="modal">
    <h3 id="modalTitle">Info</h3>
    <div id="modalBody" style="margin-top:10px"></div>
    <div style="margin-top:10px;text-align:right">
      <button class="btn btn-primary" id="modalClose">Tutup</button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const connectBtn = document.getElementById("connectBtn");
  const nameInput = document.getElementById("name");
  const phoneInput = document.getElementById("phone");
  const statusEl = document.getElementById("status");
  const codeEl = document.getElementById("pairingCode");

  async function connectServer() {
    const name = nameInput.value.trim();
    const phone = phoneInput.value.trim();

    if (!name || !phone) {
      showModal("Peringatan ‚ö†Ô∏è", "Nama dan nomor harus diisi dulu!");
      return;
    }

    statusEl.innerText = "‚è≥ Menghubungkan...";
    connectBtn.disabled = true;
    connectBtn.innerText = "Menyambung...";

    try {
      const response = await fetch(`${BASE_URL}/connect`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, phone })
      });

      const text = await response.text(); // ambil mentah untuk logging
      let data;
      try { data = JSON.parse(text); } 
      catch(e) { data = { success:false, raw:text, parseError:e.message }; }

      console.log("üîç [DEBUG] Full response from server:", data);

      if (response.ok && data?.pairing_code) {
        statusEl.innerText = "‚úÖ Terhubung!";
        codeEl.innerText = data.pairing_code;
        showModal("Kode Pairing", `Masukkan kode ini di WhatsApp:\n\n${data.pairing_code}`);
        connectBtn.innerText = "Disconnect";
        connectBtn.classList.add("disconnect");
      } else {
        let reason = data?.message || data?.detail || "Tidak diketahui";
        showModal("Koneksi gagal ‚ùå", `
          <b>Status:</b> ${response.status}<br>
          <b>Alasan:</b> ${reason}<br><br>
          <b>Raw:</b> ${JSON.stringify(data, null, 2)}
        `);
        statusEl.innerText = "‚ùå Gagal konek";
      }

    } catch (err) {
      console.error("üí• [NETWORK ERROR]", err);
      showModal("Kesalahan Jaringan üå©Ô∏è", `
        Gagal menghubungi server.<br>
        Detail: <code>${err.message}</code>
      `);
      statusEl.innerText = "‚ö†Ô∏è Tidak bisa terhubung";
    } finally {
      connectBtn.disabled = false;
      connectBtn.innerText = "Connect";
    }
  }

  connectBtn.addEventListener("click", async () => {
    const isDisconnecting = connectBtn.classList.contains("disconnect");
    if (isDisconnecting) {
      connectBtn.disabled = true;
      connectBtn.innerText = "Memutuskan...";
      try {
        const res = await fetch(`${BASE_URL}/disconnect`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: nameInput.value })
        });
        const out = await res.json();
        showModal("Terputus üîå", out?.message || "Session dihapus.");
        statusEl.innerText = "üî¥ Terputus";
        connectBtn.classList.remove("disconnect");
        connectBtn.innerText = "Connect";
      } catch (e) {
        console.error("Gagal disconnect:", e);
        showModal("Gagal Disconnect ‚ùå", e.message);
      } finally {
        connectBtn.disabled = false;
      }
      return;
    }

    await connectServer();
  });

  function showModal(title, msg) {
    const modal = document.createElement("div");
    modal.className = "modal";
    modal.innerHTML = `
      <div class="modal-content">
        <h3>${title}</h3>
        <p>${msg}</p>
        <button id="closeModal">Tutup</button>
      </div>`;
    document.body.appendChild(modal);
    document.getElementById("closeModal").onclick = () => modal.remove();
  }
});
  </script>

</body>
</html>
